---
- hosts: control_plane
  become: true

  tasks:
    - name: Allow Kubernetes control plane ports in UFW
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: tcp
        comment: "{{ item.comment }}"
      with_items:
        - { port: 6443, comment: "Open Kubernetes API Server port" }
        - { port: 2379:2380, comment: "Open etcd server client API ports" }
        - { port: 10259, comment: "Open kube-scheduler port" }
        - { port: 10257, comment: "Open kube-controller-manager port" }

    - name: Enable UFW
      ufw:
        state: enabled

- hosts: all
  become: true

  tasks:
    -
    - name: Allow Kubernetes control plane ports in UFW
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: tcp
        comment: "{{ item.comment }}"
      with_items:
        - { port: 10250, comment: "Open Kubelet API port" }
        - { port: 30000:32767, comment: "NodePort Services" }

    - name: Enable UFW
      ufw:
        state: enabled

    - name: Remove swapfile from /etc/fstab
      mount:
        name: "{{ item }}"
        fstype: swap
        state: absent
      with_items:
        - swap
        - none

    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Disable swap permanently, persist reboots
      replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
        replace: '#\1\2\3swap\4'
        backup: yes

    - name: Create a empty file for kubernetes sysctl params.
      copy:
        content: ""
        dest: /etc/sysctl.d/99-kubernetes-cri.conf
        force: no

    - name: Configure sysctl params for Kubernetes.
      lineinfile:
        path: /etc/sysctl.d/99-kubernetes-cri.conf
        line: "{{ item }}"
      with_items:
        - 'net.bridge.bridge-nf-call-iptables  = 1'
        - 'net.bridge.bridge-nf-call-ip6tables = 1'
        - 'net.ipv4.ip_forward                 = 1'

    - name: Apply sysctl params without reboot.
      command: sysctl --system
